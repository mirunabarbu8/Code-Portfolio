---
title: "Manuscript plots - ABCD"
author: "Miruna Barbu"
date: "15/02/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load R Packages
# install.packages("DiagrammeR")
library(DiagrammeR)
# install.packages("readr")
library(readr)
library(tidyverse)
# install.packages("ggrepel")
library(ggrepel)
library(RColorBrewer)
library(grid)
# install.packages("pander")
library(pander)
library(knitr)
# install.packages("kableExtra")
library(kableExtra)
library(scales)
library(data.table)
# install.packages("ggseg")
library(ggseg)
library(forcats) # For ordering variables in ggplot in specific order
library(ggtext)
library(glue)
library(tidytext)
# install.packages("gameofthrones")
library(gameofthrones)
library(ggpubr)

```

The current document contains all code used to create plots for the SCZ PRS manuscript in the ABCD cohort. The plots will only reflect associations at p-value threshold < 0.1. The structure of the file is as follows:

1. Results are presented separately for each pathway.

2. Common imaging variables will be separated by facets on the same plot (e.g. FA and MD in the axon pathway will be in the same plot; all cortical imaging modalities will be in the same plot).

3. Results comprise of: 
- table of results showing standardised effect size, p-value, and FDR p-value
- standardised effect size plot

### Axon pathway - results

#### Clinical phenotypes {.tabset}

##### Associations at PRS p-threshold ≤ 0.1

```{r axon clin assocs at p-threshold < 0.1, echo=FALSE}
# Read in entire results dataset
pps=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/pps/pps_scz3_final_results.csv")

ksads=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/ksads/ksads_scz3_final_results.csv")

prs_df=rbind(pps,ksads)

# Create a variable that indicates whether it is a pathway or a wg PRS
prs_df$pathway=ifelse(grepl("pathwayprs",prs_df$model),"Pathway PRS","WG PRS")

axon=subset(prs_df, grepl("axon", prs_df$model))
# Create a variable that better states the PLE and threshold (as we have now separated by pathway)
axon$ple=sub("*_snps_in_axon", "", axon$model)  
# Change name of phenotype
axon$pheno=sub(".*pps.*", "PPS total score", axon$model, ignore.case = TRUE)
axon$pheno=sub(".*distress.*", "PPS distress score", axon$pheno, ignore.case = TRUE)
axon$pheno=sub(".*psychosis.*", "KSADS current symptom score", axon$pheno, ignore.case = TRUE)

# Create a variable that selects ONLY the p-value threshold (to then subset by this) 
axon$thres=sub(".*axon_", "", axon$model)
axon$thres=sub("_pps_y_ss_number", "", axon$thres)
axon$thres=sub("_distress_score", "", axon$thres)
axon$thres=sub("_symptom_psychosis_score", "", axon$thres)
axon$thres=as.numeric(axon$thres)

# Subset for assocs at p-threshold < 0.1
axonthres=subset(axon, thres ==0.1)

# Create a variable that excludes the p-value threshold from column (we already know this is just 0.1)
axonthres$ple=sub("_axon_0.1*.", "", axonthres$model) 

# Prep for table
axontable=axonthres[,c(10,8,1,4,7)]

# Provide table with significant results highlighted
color.me <- which(axontable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
axontable=axontable %>% mutate_if(is.numeric,as.character)

axontable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")
  
```

##### Effect size plot

```{r axon clin effect size, echo=FALSE}
# Read in entire results dataset
pps=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/pps/pps_scz3_final_results.csv")

ksads=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/ksads/ksads_scz3_final_results.csv")

prs_df=rbind(pps,ksads)

# Create a variable that indicates whether it is a pathway or a wg PRS
prs_df$pathway=ifelse(grepl("pathwayprs",prs_df$model),"Pathway PRS","WG PRS")

axon=subset(prs_df, grepl("axon", prs_df$model))
# Create a variable that better states the PLE and threshold (as we have now separated by pathway)
axon$ple=sub("*_snps_in_axon", "", axon$model)  
# Change name of phenotype
axon$pheno=sub(".*pps.*", "PPS total score", axon$model, ignore.case = TRUE)
axon$pheno=sub(".*distress.*", "PPS distress score", axon$pheno, ignore.case = TRUE)
axon$pheno=sub(".*psychosis.*", "KSADS current symptom score", axon$pheno, ignore.case = TRUE)

# Create a variable that selects ONLY the p-value threshold (to then subset by this) 
axon$thres=sub(".*axon_", "", axon$model)
axon$thres=sub("_pps_y_ss_number", "", axon$thres)
axon$thres=sub("_distress_score", "", axon$thres)
axon$thres=sub("_symptom_psychosis_score", "", axon$thres)
axon$thres=as.numeric(axon$thres)

# Subset for assocs at p-threshold < 0.1
axonthres=subset(axon, thres ==0.1)

# Create a variable that excludes the p-value threshold from column (we already know this is just 0.1)
axonthres$ple=sub("_axon_0.1*.", "", axonthres$model) 

# Ggplot effect size graph
# Subset to include standard error as well
ggaxontable=axonthres[,c(10,8,1,2,4,7)]
# Provide rows in table that should have a star in ggplot
ggaxontable$sign[ggaxontable$pval.adj < 0.05]<-"***"
# Assign hjust and vjust
hjust = if_else(ggaxontable$pathway == "Pathway PRS", 5, -5)
vjust = if_else(ggaxontable$pathway == "Pathway PRS", 2, -1.5)

# ggplot
axonplot=ggplot(ggaxontable, aes(x=pheno, y=Value,color=pathway)) + 
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = Value - Std.Error, ymax = Value + Std.Error), width = 0.2,alpha=0.5) +
  scale_y_continuous(limits = c(-0.2, 0.2)) +
  geom_text(aes(x = pheno, y = Value, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  labs(x = "Clinical phenotypes", 
       y = "Standardised effect size", 
       title = "Axon pathway and whole-genome PRS (p < 0.1) \nin relation to clinical phenotypes in ABCD") +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_clinical_axon_effectsize.tiff",
#      width=2200, height=600, res = 300)
# axonplot
# dev.off()

```

```{r axon clin ggplot, fig.width = 10, fig.height = 3,echo=FALSE,warning=FALSE}
# ggplot needs its own chunk to print graphs!
axonplot

```

#### {-}

#### Imaging phenotypes {.tabset}

##### Associations at PRS p-threshold ≤ 0.1

Associations are presented only for PRS p-threshold ≤ 0.1; imaging phenotypes are: white matter microstructure; cortical regions (surface area, thickness, volume, sulcal depth); and subcortical volumes.

##### White matter microstructure - results table

```{r axon white matter assocs at p-threshold < 0.1, echo=FALSE}
# Read in entire results dataset
fa_prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/dti/fdr_final_results/for_rmarkdown_file/abcd_fa_all_complete_scz3_final_results.csv")

md_prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/dti/fdr_final_results/for_rmarkdown_file/abcd_md_all_complete_scz3_final_results.csv")

prs_df=rbind(fa_prs_df,md_prs_df)

axon=subset(prs_df, grepl("axon",prs_df$name))

# Subset for assocs at p-threshold < 0.1
axonthres=subset(axon, thres ==0.1)

# Prep for table
axontable=axonthres[,c(12,9,1,4,8)]

# Provide table with significant results highlighted
color.me <- which(axontable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
axontable=axontable %>% mutate_if(is.numeric,as.character)

axontable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")

```

##### White matter microstructure - effect size plot

```{r axon white matter effect size, echo=FALSE}
# Read in entire results dataset
fa_prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/dti/fdr_final_results/for_rmarkdown_file/abcd_fa_all_complete_scz3_final_results.csv")

md_prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/dti/fdr_final_results/for_rmarkdown_file/abcd_md_all_complete_scz3_final_results.csv")

prs_df=rbind(fa_prs_df,md_prs_df)

axon=subset(prs_df, grepl("axon",prs_df$name))

# Subset for assocs at p-threshold < 0.1
axonthres=subset(axon, thres ==0.1)

# Ggplot effect size graph
# Subset to include standard error as well
ggaxontable=axonthres[,c(12,9,1,2,4,8)]
# Turn brain region to factor to arrange it in order of dataframe
ggaxontable$brain_pathway=paste(ggaxontable$pathway, "-", ggaxontable$brain_reg)

# Create a new column name that takes the type of imaging modality (FA or MD)
ggaxontable$mode <- ifelse(grepl("MD", ggaxontable$brain_pathway, ignore.case = T), "Mean diffusivity","Fractional anisotropy")

# Rename "brain_pathway" variables - this will make the names of the cortical regions clearer in the ggplot; do this only for "ggaxontable", then "names" will be used with all other pathways
# Save column to csv file and assign non-shortened names to each variable
# names=ggaxontable$brain_pathway
# write.csv(names, "/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/ggplot_cortical_names.csv",quote=F,row.names=F)

# Read back in and merge with ggplot table
names=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/dti/ggplot_names.csv")

# Order rows of "ggaxontable" by rows of "names"
ggaxontable <- ggaxontable[match(names$brain_pathway, ggaxontable$brain_pathway),]

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order; NEED to do before cbind (below) as otherwise dataframe can't be transformed with duplicate names
ggaxontable=ggaxontable %>% mutate(row = row_number())

# Get rid of "brain pathway" - this was just used to re-order dataset
names=names[,c(1)]
ggaxontable=cbind(ggaxontable,names)

### ggplot based on "mode" (different imaging modalities)
axonplot <- ggplot(ggaxontable, aes(x = reorder(names,row), y = estimate, group = mode)) +
  facet_grid(. ~ mode, scales = "free", space = "free") +
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = estimate - sd_error, ymax = estimate + sd_error), width = 0.2,size=0.5,alpha=0.5) +
  scale_y_continuous(limits = c(-0.06, 0.06)) +
  scale_x_discrete(limits=rev) +
  # geom_text(aes(x = brain_region, y = Value, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  labs(x = "White matter microstructure", 
       y = "Standardised effect size", 
       title = "Axon pathway and whole-genome PRS (p < 0.1) in relation to white matter microstructure in ABCD") +
  # scale_x_discrete(labels=function(x) highlight(x, sign, "darkgreen")) +
  theme(axis.text.y=element_markdown()) +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save plot - for manuscript
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_whitematter_axon_effectsize.tiff",
#      width=3400, height=1800, res = 300)
# axonplot
# dev.off()


```

```{r axon wm ggplot, fig.width = 15, fig.height = 10,echo=FALSE,warning=FALSE}
# ggplot needs its own chunk to print graphs!
axonplot

```

##### Cortical regions - results table

```{r cort axon assocs at p-threshold < 0.1, echo=FALSE}
# Read in entire results dataset
prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/fdr_final_results/for_rmarkdown_file/abcd_cortical_complete_scz3_final_results.csv")

axon=subset(prs_df, grepl("axon", prs_df$name))

# Subset for assocs at p-threshold < 0.1
axonthres=subset(axon, thres ==0.1)

axonthres$brain_reg=str_replace_all(axonthres$brain_reg, "axon ","")

# Prep for table
axontable=axonthres[,c(12,9,1,4,8)]

# Provide table with significant results highlighted
color.me <- which(axontable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
axontable=axontable %>% mutate_if(is.numeric,as.character)

axontable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")

```

##### Cortical regions - effect size plot

```{r cort axon effect size, echo=FALSE}
# Read in entire results dataset
prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/fdr_final_results/for_rmarkdown_file/abcd_cortical_complete_scz3_final_results.csv")

axon=subset(prs_df, grepl("axon", prs_df$name))

# Subset for assocs at p-threshold < 0.1
axonthres=subset(axon, thres ==0.1)

axonthres$brain_reg=str_replace_all(axonthres$brain_reg, "axon ","")

# Ggplot effect size graph
# Subset to include standard error as well
ggaxontable=axonthres[,c(12,9,1,2,4,8)]
# Turn brain region to factor to arrange it in order of dataframe
ggaxontable$brain_pathway=paste(ggaxontable$pathway, "-", ggaxontable$brain_reg)

# Create a new column name that takes the type of cortical imaging modality
# Create a new variable in "bldata" that takes only the pathway name to be corrected by
ggaxontable$cortical_mod <- ifelse(grepl("thick|thickness", ggaxontable$brain_pathway, ignore.case = T), "Thickness", 
                      ifelse(grepl("area", ggaxontable$brain_pathway, ignore.case = T), "Surface area",
                             ifelse(grepl("sulc |sulcdepth", ggaxontable$brain_pathway, ignore.case = T), "Sulcal depth","Volume")))

# Rename "brain_pathway" variables - this will make the names of the cortical regions clearer in the ggplot; do this only for "ggaxontable", then "names" will be used with all other pathways
# Save column to csv file and assign non-shortened names to each variable
# names=ggaxontable$brain_pathway
# write.csv(names, "/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/ggplot_cortical_names.csv",quote=F,row.names=F)

# Read back in and merge with ggplot table
names=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/ggplot_cortical_names.csv")

# Order rows by rows of "names"
ggaxontable <- ggaxontable[match(names$brain_pathway, ggaxontable$brain_pathway),]

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order; NEED to do before cbind (below) as otherwise dataframe can't be transformed with duplicate names
ggaxontable=ggaxontable %>% mutate(row = row_number())

# Get rid of "brain pathway" - this was just used to re-order dataset
names=names[,c(2)]
ggaxontable=cbind(ggaxontable,names)

### ggplot based on "mode" (different imaging modalities)
axonplot <- ggplot(ggaxontable, aes(x = reorder(names,row), y = estimate, group = cortical_mod)) +
  facet_grid(. ~ cortical_mod, scales = "free", space = "free") +
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = estimate - sd_error, ymax = estimate + sd_error), width = 0.2,size=0.5,alpha=0.5) +
  scale_y_continuous(limits = c(-0.06, 0.06)) +
  scale_x_discrete(limits=rev) +
  # geom_text(aes(x = brain_region, y = Value, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  labs(x = "Cortical regions", 
       y = "Standardised effect size", 
       title = "Axon pathway and whole-genome PRS (p < 0.1) in relation to cortical regions in ABCD") +
  # scale_x_discrete(labels=function(x) highlight(x, sign, "darkgreen")) +
  theme(axis.text.y=element_markdown()) +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save plot - for manuscript
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_cortical_axon_effectsize.tiff",
#      width=3600, height=2600, res = 300)
# axonplot
# dev.off()

```

```{r axon cort ggplot, fig.width = 15, fig.height = 10,echo=FALSE,warning=FALSE}
# ggplot needs its own chunk to print graphs!
axonplot

```

##### Subcortical volumes - results table

```{r subcort axon assocs at p-threshold < 0.1, echo=FALSE}
# Read in entire results dataset
prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/subcortical/fdr_final_results/for_rmarkdown_file/abcd_subc_complete_scz3_final_results.csv")

axon=subset(prs_df, grepl("axon", prs_df$name))

# Subset for assocs at p-threshold < 0.1
axonthres=subset(axon, thres ==0.1)

axonthres$brain_reg=str_replace_all(axonthres$brain_reg, "axon ","")

# Prep for table
axontable=axonthres[,c(12,9,1,4,8)]

# Provide table with significant results highlighted
color.me <- which(axontable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
axontable=axontable %>% mutate_if(is.numeric,as.character)

axontable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")

```

##### Subcortical volumes - effect size plot

```{r subcort axon effect size, echo=FALSE}
# Read in entire results dataset
prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/subcortical/fdr_final_results/for_rmarkdown_file/abcd_subc_complete_scz3_final_results.csv")

axon=subset(prs_df, grepl("axon", prs_df$name))

# Subset for assocs at p-threshold < 0.1
axonthres=subset(axon, thres ==0.1)

axonthres$brain_reg=str_replace_all(axonthres$brain_reg, "axon ","")

# Ggplot effect size graph
# Subset to include standard error as well
ggaxontable=axonthres[,c(12,9,1,2,4,8)]
# Turn brain region to factor to arrange it in order of dataframe
ggaxontable$brain_pathway=paste(ggaxontable$pathway, "-", ggaxontable$brain_reg)

# Rename "brain_pathway" variables - this will make the names of the cortical regions clearer in the ggplot; do this only for "ggaxontable", then "names" will be used with all other pathways
# Save column to csv file and assign non-shortened names to each variable
# names=ggaxontable$brain_pathway
# write.csv(names, "/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/subcortical/ggplot_subcortical_names.csv",quote=F,row.names=F)

# Read back in and merge with ggplot table
names=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/subcortical/ggplot_subcortical_names.csv")

# Order rows by rows of "names"
ggaxontable <- ggaxontable[match(names$brain_pathway, ggaxontable$brain_pathway),]

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order; NEED to do before cbind (below) as otherwise dataframe can't be transformed with duplicate names
ggaxontable=ggaxontable %>% mutate(row = row_number())

# Get rid of "brain pathway" - this was just used to re-order dataset
names=names[,c(2)]
ggaxontable=cbind(ggaxontable,names)

# ggplot
axonplot=ggplot(ggaxontable, aes(x=reorder(names,row), y=estimate,color=pathway)) + 
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = estimate - sd_error, ymax = estimate + sd_error), width = 0.2,alpha=0.5) +
  scale_y_continuous(limits = c(-0.04, 0.04)) +
#  geom_text(aes(x = pheno, y = estimate, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  scale_x_discrete(limits=rev) +
  labs(x = "Subcortical volumes", 
       y = "Standardised effect size", 
       title = "Axon pathway and whole-genome PRS (p < 0.1) \nin relation to subcortical volumes in ABCD") +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save plot - for manuscript
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_subcortical_axon_effectsize.tiff",
#      width=2400, height=1000, res = 300)
# axonplot
# dev.off()

```

```{r axon cort ggplot, fig.width = 15, fig.height = 10,echo=FALSE,warning=FALSE}
# ggplot needs its own chunk to print graphs!
axonplot

```

#### {-}

### Histone pathway - results {.tabset}

#### Clinical phenotypes

```{r histone assocs at p-threshold < 0.1, echo=FALSE}
# Read in entire results dataset
pps=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/pps/pps_scz3_final_results.csv")

ksads=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/ksads/ksads_scz3_final_results.csv")

prs_df=rbind(pps,ksads)

# Create a variable that indicates whether it is a pathway or a wg PRS
prs_df$pathway=ifelse(grepl("pathwayprs",prs_df$model),"Pathway PRS","WG PRS")

histone=subset(prs_df, grepl("histone", prs_df$model))
# Create a variable that better states the PLE and threshold (as we have now separated by pathway)
histone$ple=sub("*_snps_in_histone", "", histone$model)  
# Change name of phenotype
histone$pheno=sub(".*pps.*", "PPS total score", histone$model, ignore.case = TRUE)
histone$pheno=sub(".*distress.*", "PPS distress score", histone$pheno, ignore.case = TRUE)
histone$pheno=sub(".*psychosis.*", "KSADS current symptom score", histone$pheno, ignore.case = TRUE)

# Create a variable that selects ONLY the p-value threshold (to then subset by this) 
histone$thres=sub(".*histone_", "", histone$model)
histone$thres=sub("_pps_y_ss_number", "", histone$thres)
histone$thres=sub("_distress_score", "", histone$thres)
histone$thres=sub("_symptom_psychosis_score", "", histone$thres)
histone$thres=as.numeric(histone$thres)

# Subset for assocs at p-threshold < 0.1
histonethres=subset(histone, thres ==0.1)

# Create a variable that excludes the p-value threshold from column (we already know this is just 0.1)
histonethres$ple=sub("_histone_0.1*.", "", histonethres$model) 

# Prep for table
histonetable=histonethres[,c(10,8,1,4,7)]

# Provide table with significant results highlighted
color.me <- which(histonetable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
histonetable=histonetable %>% mutate_if(is.numeric,as.character)

histonetable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")
  
# Ggplot effect size graph
# Subset to include standard error as well
gghistonetable=histonethres[,c(10,8,1,2,4,7)]
# Provide rows in table that should have a star in ggplot
gghistonetable$sign[gghistonetable$pval.adj < 0.05]<-"***"
# Assign hjust and vjust
hjust = if_else(gghistonetable$pathway == "Pathway PRS", 5, -5)
vjust = if_else(gghistonetable$pathway == "Pathway PRS", 2, -1.5)

# ggplot
histoneplot=ggplot(gghistonetable, aes(x=pheno, y=Value,color=pathway)) + 
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = Value - Std.Error, ymax = Value + Std.Error), width = 0.2,alpha=0.5) +
  scale_y_continuous(limits = c(-0.2, 0.2)) +
  geom_text(aes(x = pheno, y = Value, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  labs(x = "Clinical phenotypes", 
       y = "Standardised effect size", 
       title = "Histone pathway and whole-genome PRS (p < 0.1) \nin relation to clinical phenotypes in ABCD") +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_clinical_histone_effectsize.tiff",
#      width=2200, height=600, res = 300)
# histoneplot
# dev.off()

```

#### Imaging phenotypes

##### White matter microstructure

```{r white matter histone assocs at p-threshold < 0.1, echo=FALSE}
# Read in entire results dataset
fa_prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/dti/fdr_final_results/for_rmarkdown_file/abcd_fa_all_complete_scz3_final_results.csv")

md_prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/dti/fdr_final_results/for_rmarkdown_file/abcd_md_all_complete_scz3_final_results.csv")

prs_df=rbind(fa_prs_df,md_prs_df)

histone=subset(prs_df, grepl("histone",prs_df$name))

# Subset for assocs at p-threshold < 0.1
histonethres=subset(histone, thres ==0.1)

# Prep for table
histonetable=histonethres[,c(12,9,1,4,8)]

# Provide table with significant results highlighted
color.me <- which(histonetable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
histonetable=histonetable %>% mutate_if(is.numeric,as.character)

histonetable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")

# Ggplot effect size graph
# Subset to include standard error as well
gghistonetable=histonethres[,c(12,9,1,2,4,8)]
# Turn brain region to factor to arrange it in order of dataframe
gghistonetable$brain_pathway=paste(gghistonetable$pathway, "-", gghistonetable$brain_reg)

# Create a new column name that takes the type of imaging modality (FA or MD)
gghistonetable$mode <- ifelse(grepl("MD", gghistonetable$brain_pathway, ignore.case = T), "Mean diffusivity","Fractional anisotropy")
# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order
gghistonetable=gghistonetable %>% mutate(row = row_number())

# Rename "brain_pathway" variables - this will make the names of the cortical regions clearer in the ggplot; do this only for "ggaxontable", then "names" will be used with all other pathways
# Save column to csv file and assign non-shortened names to each variable
# names=ggaxontable$brain_pathway
# write.csv(names, "/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/ggplot_cortical_names.csv",quote=F,row.names=F)

# Read back in and merge with ggplot table
names=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/dti/ggplot_names.csv")

# Order rows by rows of "names"
gghistonetable <- gghistonetable[match(names$brain_pathway, gghistonetable$brain_pathway),]

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order; NEED to do before cbind (below) as otherwise dataframe can't be transformed with duplicate names
gghistonetable=gghistonetable %>% mutate(row = row_number())

# Get rid of "brain pathway" - this was just used to re-order dataset
names=names[,c(1)]
gghistonetable=cbind(gghistonetable,names)

### ggplot based on "mode" (different imaging modalities)
histoneplot <- ggplot(gghistonetable, aes(x = reorder(names,row), y = estimate, group = mode)) +
  facet_grid(. ~ mode, scales = "free", space = "free") +
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = estimate - sd_error, ymax = estimate + sd_error), width = 0.2,size=0.5,alpha=0.5) +
  scale_y_continuous(limits = c(-0.06, 0.06)) +
  scale_x_discrete(limits=rev) +
  # geom_text(aes(x = brain_region, y = Value, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  labs(x = "White matter microstructure", 
       y = "Standardised effect size", 
       title = "Histone pathway and whole-genome PRS (p < 0.1) in relation to white matter microstructure in ABCD") +
  # scale_x_discrete(labels=function(x) highlight(x, sign, "darkgreen")) +
  theme(axis.text.y=element_markdown()) +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save plot - for manuscript
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_whitematter_histone_effectsize.tiff",
#      width=3400, height=1800, res = 300)
# histoneplot
# dev.off()

```

##### Cortical regions

```{r cort histone assocs at p-threshold < 0.1, echo=FALSE}
# Read in entire results dataset
prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/fdr_final_results/for_rmarkdown_file/abcd_cortical_complete_scz3_final_results.csv")

histone=subset(prs_df, grepl("histone", prs_df$name))

# Subset for assocs at p-threshold < 0.1
histonethres=subset(histone, thres ==0.1)

histonethres$brain_reg=str_replace_all(histonethres$brain_reg, "histone ","")

# Prep for table
histonetable=histonethres[,c(12,9,1,4,8)]

# Provide table with significant results highlighted
color.me <- which(histonetable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
histonetable=histonetable %>% mutate_if(is.numeric,as.character)

histonetable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")

# Ggplot effect size graph
# Subset to include standard error as well
gghistonetable=histonethres[,c(12,9,1,2,4,8)]
# Turn brain region to factor to arrange it in order of dataframe
gghistonetable$brain_pathway=paste(gghistonetable$pathway, "-", gghistonetable$brain_reg)

# Create a new column name that takes the type of cortical imaging modality
# Create a new variable in "bldata" that takes only the pathway name to be corrected by
gghistonetable$cortical_mod <- ifelse(grepl("thick|thickness", gghistonetable$brain_pathway, ignore.case = T), "Thickness", 
                      ifelse(grepl("area", gghistonetable$brain_pathway, ignore.case = T), "Surface area",
                             ifelse(grepl("sulc |sulcdepth", gghistonetable$brain_pathway, ignore.case = T), "Sulcal depth","Volume")))

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order
gghistonetable=gghistonetable %>% mutate(row = row_number())

# Rename "brain_pathway" variables - this will make the names of the cortical regions clearer in the ggplot; do this only for "ggaxontable", then "names" will be used with all other pathways
# Save column to csv file and assign non-shortened names to each variable
# names=ggaxontable$brain_pathway
# write.csv(names, "/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/ggplot_cortical_names.csv",quote=F,row.names=F)

# Read back in and merge with ggplot table
names=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/ggplot_cortical_names.csv")

# Order rows by rows of "names"
gghistonetable <- gghistonetable[match(names$brain_pathway, gghistonetable$brain_pathway),]

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order; NEED to do before cbind (below) as otherwise dataframe can't be transformed with duplicate names
gghistonetable=gghistonetable %>% mutate(row = row_number())

# Get rid of "brain pathway" - this was just used to re-order dataset
names=names[,c(2)]
gghistonetable=cbind(gghistonetable,names)

### ggplot based on "mode" (different imaging modalities)
histoneplot <- ggplot(gghistonetable, aes(x = reorder(names,row), y = estimate, group = cortical_mod)) +
  facet_grid(. ~ cortical_mod, scales = "free", space = "free") +
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = estimate - sd_error, ymax = estimate + sd_error), width = 0.2,size=0.5,alpha=0.5) +
  scale_y_continuous(limits = c(-0.06, 0.06)) +
  scale_x_discrete(limits=rev) +
  # geom_text(aes(x = brain_region, y = Value, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  labs(x = "Cortical regions", 
       y = "Standardised effect size", 
       title = "Histone pathway and whole-genome PRS (p < 0.1) in relation to cortical regions in ABCD") +
  # scale_x_discrete(labels=function(x) highlight(x, sign, "darkgreen")) +
  theme(axis.text.y=element_markdown()) +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save plot - for manuscript
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_cortical_histone_effectsize.tiff",
#      width=3600, height=2600, res = 300)
# histoneplot
# # dev.off()

```

#### Subcortical volumes

```{r subcort histone effect size, echo=FALSE}
# Read in entire results dataset
prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/subcortical/fdr_final_results/for_rmarkdown_file/abcd_subc_complete_scz3_final_results.csv")

histone=subset(prs_df, grepl("histone", prs_df$name))

# Subset for assocs at p-threshold < 0.1
histonethres=subset(histone, thres ==0.1)

histonethres$brain_reg=str_replace_all(histonethres$brain_reg, "histone ","")

# Prep for table
histonetable=histonethres[,c(12,9,1,4,8)]

# Provide table with significant results highlighted
color.me <- which(histonetable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
histonetable=histonetable %>% mutate_if(is.numeric,as.character)

histonetable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")

# Ggplot effect size graph
# Subset to include standard error as well
gghistonetable=histonethres[,c(12,9,1,2,4,8)]
# Turn brain region to factor to arrange it in order of dataframe
gghistonetable$brain_pathway=paste(gghistonetable$pathway, "-", gghistonetable$brain_reg)

# Rename "brain_pathway" variables - this will make the names of the cortical regions clearer in the ggplot; do this only for "ggaxontable", then "names" will be used with all other pathways
# Save column to csv file and assign non-shortened names to each variable
# names=ggaxontable$brain_pathway
# write.csv(names, "/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/subcortical/ggplot_subcortical_names.csv",quote=F,row.names=F)

# Read back in and merge with ggplot table
names=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/subcortical/ggplot_subcortical_names.csv")

# Order rows by rows of "names"
gghistonetable <- gghistonetable[match(names$brain_pathway, gghistonetable$brain_pathway),]

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order; NEED to do before cbind (below) as otherwise dataframe can't be transformed with duplicate names
gghistonetable=gghistonetable %>% mutate(row = row_number())

# Get rid of "brain pathway" - this was just used to re-order dataset
names=names[,c(2)]
gghistonetable=cbind(gghistonetable,names)

# ggplot
histoneplot=ggplot(gghistonetable, aes(x=reorder(names,row), y=estimate,color=pathway)) + 
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = estimate - sd_error, ymax = estimate + sd_error), width = 0.2,alpha=0.5) +
  scale_y_continuous(limits = c(-0.04, 0.04)) +
#  geom_text(aes(x = pheno, y = estimate, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  scale_x_discrete(limits=rev) +
  labs(x = "Subcortical volumes", 
       y = "Standardised effect size", 
       title = "Histone pathway and whole-genome PRS (p < 0.1) \nin relation to subcortical volumes in ABCD") +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save plot - for manuscript
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_subcortical_histone_effectsize.tiff",
#      width=2400, height=1000, res = 300)
# histoneplot
# dev.off()

```

### Dendritic spine pathway - results

#### Clinical phenotypes

```{r dendspine assocs at p-threshold < 0.1, echo=FALSE}
# Read in entire results dataset
pps=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/pps/pps_scz3_final_results.csv")

ksads=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/ksads/ksads_scz3_final_results.csv")

prs_df=rbind(pps,ksads)

# Create a variable that indicates whether it is a pathway or a wg PRS
prs_df$pathway=ifelse(grepl("pathwayprs",prs_df$model),"Pathway PRS","WG PRS")

dendspine=subset(prs_df, grepl("dendspine", prs_df$model))
# Create a variable that better states the PLE and threshold (as we have now separated by pathway)
dendspine$ple=sub("*_snps_in_dendspine", "", dendspine$model)  
# Change name of phenotype
dendspine$pheno=sub(".*pps.*", "PPS total score", dendspine$model, ignore.case = TRUE)
dendspine$pheno=sub(".*distress.*", "PPS distress score", dendspine$pheno, ignore.case = TRUE)
dendspine$pheno=sub(".*psychosis.*", "KSADS current symptom score", dendspine$pheno, ignore.case = TRUE)

# Create a variable that selects ONLY the p-value threshold (to then subset by this) 
dendspine$thres=sub(".*dendspine_", "", dendspine$model)
dendspine$thres=sub("_pps_y_ss_number", "", dendspine$thres)
dendspine$thres=sub("_distress_score", "", dendspine$thres)
dendspine$thres=sub("_symptom_psychosis_score", "", dendspine$thres)
dendspine$thres=as.numeric(dendspine$thres)

# Subset for assocs at p-threshold < 0.1
dendspinethres=subset(dendspine, thres ==0.1)

# Create a variable that excludes the p-value threshold from column (we already know this is just 0.1)
dendspinethres$ple=sub("_dendspine_0.1*.", "", dendspinethres$model) 

# Prep for table
dendspinetable=dendspinethres[,c(10,8,1,4,7)]

# Provide table with significant results highlighted
color.me <- which(dendspinetable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
dendspinetable=dendspinetable %>% mutate_if(is.numeric,as.character)

dendspinetable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")
  
# Ggplot effect size graph
# Subset to include standard error as well
ggdendspinetable=dendspinethres[,c(10,8,1,2,4,7)]
# Provide rows in table that should have a star in ggplot
ggdendspinetable$sign[ggdendspinetable$pval.adj < 0.05]<-"***"
# Assign hjust and vjust
hjust = if_else(ggdendspinetable$pathway == "Pathway PRS", 5, -5)
vjust = if_else(ggdendspinetable$pathway == "Pathway PRS", 2, -1.5)

# ggplot
dendspineplot=ggplot(ggdendspinetable, aes(x=pheno, y=Value,color=pathway)) + 
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = Value - Std.Error, ymax = Value + Std.Error), width = 0.2,alpha=0.5) +
  scale_y_continuous(limits = c(-0.2, 0.2)) +
  geom_text(aes(x = pheno, y = Value, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  labs(x = "Clinical phenotypes", 
       y = "Standardised effect size", 
       title = "Dendritic spine pathway and whole-genome PRS (p < 0.1) \nin relation to clinical phenotypes in ABCD") +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_clinical_dendspine_effectsize.tiff",
#      width=2200, height=600, res = 300)
# dendspineplot
# dev.off()

```

#### Imaging phenotypes

##### White matter microstructure

```{r white matter dendspine assocs at p-threshold < 0.1, echo=FALSE}
# Read in entire results dataset
fa_prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/dti/fdr_final_results/for_rmarkdown_file/abcd_fa_all_complete_scz3_final_results.csv")

md_prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/dti/fdr_final_results/for_rmarkdown_file/abcd_md_all_complete_scz3_final_results.csv")

prs_df=rbind(fa_prs_df,md_prs_df)

dendspine=subset(prs_df, grepl("dendspine",prs_df$name))

# Subset for assocs at p-threshold < 0.1
dendspinethres=subset(dendspine, thres ==0.1)

# Prep for table
dendspinetable=dendspinethres[,c(12,9,1,4,8)]

# Provide table with significant results highlighted
color.me <- which(dendspinetable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
dendspinetable=dendspinetable %>% mutate_if(is.numeric,as.character)

dendspinetable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")

# Ggplot effect size graph
# Subset to include standard error as well
ggdendspinetable=dendspinethres[,c(12,9,1,2,4,8)]
# Turn brain region to factor to arrange it in order of dataframe
ggdendspinetable$brain_pathway=paste(ggdendspinetable$pathway, "-", ggdendspinetable$brain_reg)

# Create a new column name that takes the type of imaging modality (FA or MD)
ggdendspinetable$mode <- ifelse(grepl("MD", ggdendspinetable$brain_pathway, ignore.case = T), "Mean diffusivity","Fractional anisotropy")
# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order
ggdendspinetable=ggdendspinetable %>% mutate(row = row_number())

# Rename "brain_pathway" variables - this will make the names of the cortical regions clearer in the ggplot; do this only for "ggaxontable", then "names" will be used with all other pathways
# Save column to csv file and assign non-shortened names to each variable
# names=ggaxontable$brain_pathway
# write.csv(names, "/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/ggplot_cortical_names.csv",quote=F,row.names=F)

# Read back in and merge with ggplot table
names=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/dti/ggplot_names.csv")

# Order rows by rows of "names"
ggdendspinetable <- ggdendspinetable[match(names$brain_pathway, ggdendspinetable$brain_pathway),]

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order; NEED to do before cbind (below) as otherwise dataframe can't be transformed with duplicate names
ggdendspinetable=ggdendspinetable %>% mutate(row = row_number())

# Get rid of "brain pathway" - this was just used to re-order dataset
names=names[,c(1)]
ggdendspinetable=cbind(ggdendspinetable,names)

### ggplot based on "mode" (different imaging modalities)
dendspineplot <- ggplot(ggdendspinetable, aes(x = reorder(names,row), y = estimate, group = mode)) +
  facet_grid(. ~ mode, scales = "free", space = "free") +
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = estimate - sd_error, ymax = estimate + sd_error), width = 0.2,size=0.5,alpha=0.5) +
  scale_y_continuous(limits = c(-0.06, 0.06)) +
  scale_x_discrete(limits=rev) +
  # geom_text(aes(x = brain_region, y = Value, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  labs(x = "White matter microstructure", 
       y = "Standardised effect size", 
       title = "Dendritic spine pathway and whole-genome PRS (p < 0.1) in relation to white matter microstructure in ABCD") +
  # scale_x_discrete(labels=function(x) highlight(x, sign, "darkgreen")) +
  theme(axis.text.y=element_markdown()) +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save plot - for manuscript
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_whitematter_dendspine_effectsize.tiff",
#      width=3400, height=1800, res = 300)
# dendspineplot
# dev.off()

```

##### Cortical regions

```{r cort dendspine assocs at p-threshold < 0.1, echo=FALSE}
# Read in entire results dataset
prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/fdr_final_results/for_rmarkdown_file/abcd_cortical_complete_scz3_final_results.csv")

dendspine=subset(prs_df, grepl("dendspine", prs_df$name))

# Subset for assocs at p-threshold < 0.1
dendspinethres=subset(dendspine, thres ==0.1)

dendspinethres$brain_reg=str_replace_all(dendspinethres$brain_reg, "dendspine ","")

# Prep for table
dendspinetable=dendspinethres[,c(12,9,1,4,8)]

# Provide table with significant results highlighted
color.me <- which(dendspinetable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
dendspinetable=dendspinetable %>% mutate_if(is.numeric,as.character)

dendspinetable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")

# Ggplot effect size graph
# Subset to include standard error as well
ggdendspinetable=dendspinethres[,c(12,9,1,2,4,8)]
# Turn brain region to factor to arrange it in order of dataframe
ggdendspinetable$brain_pathway=paste(ggdendspinetable$pathway, "-", ggdendspinetable$brain_reg)

# Create a new column name that takes the type of cortical imaging modality
# Create a new variable in "bldata" that takes only the pathway name to be corrected by
ggdendspinetable$cortical_mod <- ifelse(grepl("thick|thickness", ggdendspinetable$brain_pathway, ignore.case = T), "Thickness", 
                      ifelse(grepl("area", ggdendspinetable$brain_pathway, ignore.case = T), "Surface area",
                             ifelse(grepl("sulc |sulcdepth", ggdendspinetable$brain_pathway, ignore.case = T), "Sulcal depth","Volume")))

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order
ggdendspinetable=ggdendspinetable %>% mutate(row = row_number())

# Rename "brain_pathway" variables - this will make the names of the cortical regions clearer in the ggplot; do this only for "ggaxontable", then "names" will be used with all other pathways
# Save column to csv file and assign non-shortened names to each variable
# names=ggaxontable$brain_pathway
# write.csv(names, "/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/ggplot_cortical_names.csv",quote=F,row.names=F)

# Read back in and merge with ggplot table
names=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/ggplot_cortical_names.csv")

# Order rows by rows of "names"
ggdendspinetable <- ggdendspinetable[match(names$brain_pathway, ggdendspinetable$brain_pathway),]

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order; NEED to do before cbind (below) as otherwise dataframe can't be transformed with duplicate names
ggdendspinetable=ggdendspinetable %>% mutate(row = row_number())

# Get rid of "brain pathway" - this was just used to re-order dataset
names=names[,c(2)]
ggdendspinetable=cbind(ggdendspinetable,names)

### ggplot based on "mode" (different imaging modalities)
dendspineplot <- ggplot(ggdendspinetable, aes(x = reorder(names,row), y = estimate, group = cortical_mod)) +
  facet_grid(. ~ cortical_mod, scales = "free", space = "free") +
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = estimate - sd_error, ymax = estimate + sd_error), width = 0.2,size=0.5,alpha=0.5) +
  scale_y_continuous(limits = c(-0.06, 0.06)) +
  scale_x_discrete(limits=rev) +
  # geom_text(aes(x = brain_region, y = Value, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  labs(x = "Cortical regions", 
       y = "Standardised effect size", 
       title = "Dendritic spine pathway and whole-genome PRS (p < 0.1) in relation to cortical regions in ABCD") +
  # scale_x_discrete(labels=function(x) highlight(x, sign, "darkgreen")) +
  theme(axis.text.y=element_markdown()) +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save plot - for manuscript
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_cortical_dendspine_effectsize.tiff",
#      width=3600, height=2600, res = 300)
# dendspineplot
# dev.off()

```

#### Subcortical volumes

```{r subcort dendspine effect size, echo=FALSE}
# Read in entire results dataset
prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/subcortical/fdr_final_results/for_rmarkdown_file/abcd_subc_complete_scz3_final_results.csv")

dendspine=subset(prs_df, grepl("dendspine", prs_df$name))

# Subset for assocs at p-threshold < 0.1
dendspinethres=subset(dendspine, thres ==0.1)

dendspinethres$brain_reg=str_replace_all(dendspinethres$brain_reg, "dendspine ","")

# Prep for table
dendspinetable=dendspinethres[,c(12,9,1,4,8)]

# Provide table with significant results highlighted
color.me <- which(dendspinetable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
dendspinetable=dendspinetable %>% mutate_if(is.numeric,as.character)

dendspinetable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")

# Ggplot effect size graph
# Subset to include standard error as well
ggdendspinetable=dendspinethres[,c(12,9,1,2,4,8)]
# Turn brain region to factor to arrange it in order of dataframe
ggdendspinetable$brain_pathway=paste(ggdendspinetable$pathway, "-", ggdendspinetable$brain_reg)

# Rename "brain_pathway" variables - this will make the names of the cortical regions clearer in the ggplot; do this only for "ggaxontable", then "names" will be used with all other pathways
# Save column to csv file and assign non-shortened names to each variable
# names=ggaxontable$brain_pathway
# write.csv(names, "/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/subcortical/ggplot_subcortical_names.csv",quote=F,row.names=F)

# Read back in and merge with ggplot table
names=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/subcortical/ggplot_subcortical_names.csv")

# Order rows by rows of "names"
ggdendspinetable <- ggdendspinetable[match(names$brain_pathway, ggdendspinetable$brain_pathway),]

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order; NEED to do before cbind (below) as otherwise dataframe can't be transformed with duplicate names
ggdendspinetable=ggdendspinetable %>% mutate(row = row_number())

# Get rid of "brain pathway" - this was just used to re-order dataset
names=names[,c(2)]
ggdendspinetable=cbind(ggdendspinetable,names)

# ggplot
dendspineplot=ggplot(ggdendspinetable, aes(x=reorder(names,row), y=estimate,color=pathway)) + 
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = estimate - sd_error, ymax = estimate + sd_error), width = 0.2,alpha=0.5) +
  scale_y_continuous(limits = c(-0.04, 0.04)) +
#  geom_text(aes(x = pheno, y = estimate, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  scale_x_discrete(limits=rev) +
  labs(x = "Subcortical volumes", 
       y = "Standardised effect size", 
       title = "Dendritic spine pathway and whole-genome PRS (p < 0.1) \nin relation to subcortical volumes in ABCD") +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save plot - for manuscript
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_subcortical_dendspine_effectsize.tiff",
#      width=2400, height=1000, res = 300)
# dendspineplot
# dev.off()

```

### Postsynaptic density pathway - results

#### Clinical phenotypes

```{r postsyndens assocs at p-threshold < 0.1, echo=FALSE}
# Read in entire results dataset
pps=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/pps/pps_scz3_final_results.csv")

ksads=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/ksads/ksads_scz3_final_results.csv")

prs_df=rbind(pps,ksads)

# Create a variable that indicates whether it is a pathway or a wg PRS
prs_df$pathway=ifelse(grepl("pathwayprs",prs_df$model),"Pathway PRS","WG PRS")

postsyndens=subset(prs_df, grepl("postsyndens", prs_df$model))
# Create a variable that better states the PLE and threshold (as we have now separated by pathway)
postsyndens$ple=sub("*_snps_in_postsyndens", "", postsyndens$model)  
# Change name of phenotype
postsyndens$pheno=sub(".*pps.*", "PPS total score", postsyndens$model, ignore.case = TRUE)
postsyndens$pheno=sub(".*distress.*", "PPS distress score", postsyndens$pheno, ignore.case = TRUE)
postsyndens$pheno=sub(".*psychosis.*", "KSADS current symptom score", postsyndens$pheno, ignore.case = TRUE)

# Create a variable that selects ONLY the p-value threshold (to then subset by this) 
postsyndens$thres=sub(".*postsyndens_", "", postsyndens$model)
postsyndens$thres=sub("_pps_y_ss_number", "", postsyndens$thres)
postsyndens$thres=sub("_distress_score", "", postsyndens$thres)
postsyndens$thres=sub("_symptom_psychosis_score", "", postsyndens$thres)
postsyndens$thres=as.numeric(postsyndens$thres)

# Subset for assocs at p-threshold < 0.1
postsyndensthres=subset(postsyndens, thres ==0.1)

# Create a variable that excludes the p-value threshold from column (we already know this is just 0.1)
postsyndensthres$ple=sub("_postsyndens_0.1*.", "", postsyndensthres$model) 

# Prep for table
postsyndenstable=postsyndensthres[,c(10,8,1,4,7)]

# Provide table with significant results highlighted
color.me <- which(postsyndenstable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
postsyndenstable=postsyndenstable %>% mutate_if(is.numeric,as.character)

postsyndenstable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")
  
# Ggplot effect size graph
# Subset to include standard error as well
ggpostsyndenstable=postsyndensthres[,c(10,8,1,2,4,7)]
# Provide rows in table that should have a star in ggplot
ggpostsyndenstable$sign[ggpostsyndenstable$pval.adj < 0.05]<-"***"
# Assign hjust and vjust
hjust = if_else(ggpostsyndenstable$pathway == "Pathway PRS", 5, -5)
vjust = if_else(ggpostsyndenstable$pathway == "Pathway PRS", 2, -1.5)

postsyndensplot=ggplot(ggpostsyndenstable, aes(x=pheno, y=Value,color=pathway)) + 
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = Value - Std.Error, ymax = Value + Std.Error), width = 0.2,alpha=0.5) +
  scale_y_continuous(limits = c(-0.28, 0.28)) +
  geom_text(aes(x = pheno, y = Value, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  labs(x = "Clinical phenotypes", 
       y = "Standardised effect size", 
       title = "Postsynaptic density pathway and whole-genome PRS (p < 0.1) \nin relation to clinical phenotypes in ABCD") +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_clinical_postsyndens_effectsize.tiff",
#      width=2200, height=600, res = 300)
# postsyndensplot
# dev.off()

```

#### Imaging phenotypes

##### White matter microstructure

```{r white matter postsyndens assocs at p-threshold < 0.1, echo=FALSE}
# Read in entire results dataset
fa_prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/dti/fdr_final_results/for_rmarkdown_file/abcd_fa_all_complete_scz3_final_results.csv")

md_prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/dti/fdr_final_results/for_rmarkdown_file/abcd_md_all_complete_scz3_final_results.csv")

prs_df=rbind(fa_prs_df,md_prs_df)

postsyndens=subset(prs_df, grepl("postsyndens",prs_df$name))

# Subset for assocs at p-threshold < 0.1
postsyndensthres=subset(postsyndens, thres ==0.1)

# Prep for table
postsyndenstable=postsyndensthres[,c(12,9,1,4,8)]

# Provide table with significant results highlighted
color.me <- which(postsyndenstable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
postsyndenstable=postsyndenstable %>% mutate_if(is.numeric,as.character)

postsyndenstable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")

# Ggplot effect size graph
# Subset to include standard error as well
ggpostsyndenstable=postsyndensthres[,c(12,9,1,2,4,8)]
# Turn brain region to factor to arrange it in order of dataframe
ggpostsyndenstable$brain_pathway=paste(ggpostsyndenstable$pathway, "-", ggpostsyndenstable$brain_reg)

# Create a new column name that takes the type of imaging modality (FA or MD)
ggpostsyndenstable$mode <- ifelse(grepl("MD", ggpostsyndenstable$brain_pathway, ignore.case = T), "Mean diffusivity","Fractional anisotropy")
# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order
ggpostsyndenstable=ggpostsyndenstable %>% mutate(row = row_number())

# Rename "brain_pathway" variables - this will make the names of the cortical regions clearer in the ggplot; do this only for "ggaxontable", then "names" will be used with all other pathways
# Save column to csv file and assign non-shortened names to each variable
# names=ggaxontable$brain_pathway
# write.csv(names, "/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/ggplot_cortical_names.csv",quote=F,row.names=F)

# Read back in and merge with ggplot table
names=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/dti/ggplot_names.csv")

# Order rows by rows of "names"
ggpostsyndenstable <- ggpostsyndenstable[match(names$brain_pathway, ggpostsyndenstable$brain_pathway),]

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order; NEED to do before cbind (below) as otherwise dataframe can't be transformed with duplicate names
ggpostsyndenstable=ggpostsyndenstable %>% mutate(row = row_number())

# Get rid of "brain pathway" - this was just used to re-order dataset
names=names[,c(1)]
ggpostsyndenstable=cbind(ggpostsyndenstable,names)

### ggplot based on "mode" (different imaging modalities)
postsyndensplot <- ggplot(ggpostsyndenstable, aes(x = reorder(names,row), y = estimate, group = mode)) +
  facet_grid(. ~ mode, scales = "free", space = "free") +
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = estimate - sd_error, ymax = estimate + sd_error), width = 0.2,size=0.5,alpha=0.5) +
  scale_y_continuous(limits = c(-0.06, 0.06)) +
  scale_x_discrete(limits=rev) +
  # geom_text(aes(x = brain_region, y = Value, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  labs(x = "White matter microstructure", 
       y = "Standardised effect size", 
       title = "Postsynaptic density pathway and whole-genome PRS (p < 0.1) in relation to white matter microstructure in ABCD") +
  # scale_x_discrete(labels=function(x) highlight(x, sign, "darkgreen")) +
  theme(axis.text.y=element_markdown()) +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save plot - for manuscript
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_whitematter_postsyndens_effectsize.tiff",
#      width=3400, height=1800, res = 300)
# postsyndensplot
# dev.off()

```

##### Cortical regions

```{r cort postsyndens assocs at p-threshold < 0.1, echo=FALSE}
# Read in entire results dataset
prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/fdr_final_results/for_rmarkdown_file/abcd_cortical_complete_scz3_final_results.csv")

postsyndens=subset(prs_df, grepl("postsyndens", prs_df$name))

# Subset for assocs at p-threshold < 0.1
postsyndensthres=subset(postsyndens, thres ==0.1)

postsyndensthres$brain_reg=str_replace_all(postsyndensthres$brain_reg, "postsyndens ","")

# Prep for table
postsyndenstable=postsyndensthres[,c(12,9,1,4,8)]

# Provide table with significant results highlighted
color.me <- which(postsyndenstable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
postsyndenstable=postsyndenstable %>% mutate_if(is.numeric,as.character)

postsyndenstable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")

# Ggplot effect size graph
# Subset to include standard error as well
ggpostsyndenstable=postsyndensthres[,c(12,9,1,2,4,8)]
# Turn brain region to factor to arrange it in order of dataframe
ggpostsyndenstable$brain_pathway=paste(ggpostsyndenstable$pathway, "-", ggpostsyndenstable$brain_reg)

# Create a new column name that takes the type of cortical imaging modality
# Create a new variable in "bldata" that takes only the pathway name to be corrected by
ggpostsyndenstable$cortical_mod <- ifelse(grepl("thick|thickness", ggpostsyndenstable$brain_pathway, ignore.case = T), "Thickness", 
                      ifelse(grepl("area", ggpostsyndenstable$brain_pathway, ignore.case = T), "Surface area",
                             ifelse(grepl("sulc |sulcdepth", ggpostsyndenstable$brain_pathway, ignore.case = T), "Sulcal depth","Volume")))

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order
ggpostsyndenstable=ggpostsyndenstable %>% mutate(row = row_number())

# Rename "brain_pathway" variables - this will make the names of the cortical regions clearer in the ggplot; do this only for "ggaxontable", then "names" will be used with all other pathways
# Save column to csv file and assign non-shortened names to each variable
# names=ggaxontable$brain_pathway
# write.csv(names, "/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/ggplot_cortical_names.csv",quote=F,row.names=F)

# Read back in and merge with ggplot table
names=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/ggplot_cortical_names.csv")

# Order rows by rows of "names"
ggpostsyndenstable <- ggpostsyndenstable[match(names$brain_pathway, ggpostsyndenstable$brain_pathway),]

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order; NEED to do before cbind (below) as otherwise dataframe can't be transformed with duplicate names
ggpostsyndenstable=ggpostsyndenstable %>% mutate(row = row_number())

# Get rid of "brain pathway" - this was just used to re-order dataset
names=names[,c(2)]
ggpostsyndenstable=cbind(ggpostsyndenstable,names)

### ggplot based on "mode" (different imaging modalities)
postsyndensplot <- ggplot(ggpostsyndenstable, aes(x = reorder(names,row), y = estimate, group = cortical_mod)) +
  facet_grid(. ~ cortical_mod, scales = "free", space = "free") +
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = estimate - sd_error, ymax = estimate + sd_error), width = 0.2,size=0.5,alpha=0.5) +
  scale_y_continuous(limits = c(-0.06, 0.06)) +
  scale_x_discrete(limits=rev) +
  # geom_text(aes(x = brain_region, y = Value, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  labs(x = "Cortical regions", 
       y = "Standardised effect size", 
       title = "Postsynaptic density pathway and whole-genome PRS (p < 0.1) in relation to cortical regions in ABCD") +
  # scale_x_discrete(labels=function(x) highlight(x, sign, "darkgreen")) +
  theme(axis.text.y=element_markdown()) +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save plot - for manuscript
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_cortical_postsyndens_effectsize.tiff",
#      width=3600, height=2600, res = 300)
# postsyndensplot
# dev.off()

```

##### Subcortical volumes

```{r subcort postsyndens effect size, echo=FALSE}
# Read in entire results dataset
prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/subcortical/fdr_final_results/for_rmarkdown_file/abcd_subc_complete_scz3_final_results.csv")

postsyndens=subset(prs_df, grepl("postsyndens", prs_df$name))

# Subset for assocs at p-threshold < 0.1
postsyndensthres=subset(postsyndens, thres ==0.1)

postsyndensthres$brain_reg=str_replace_all(postsyndensthres$brain_reg, "postsyndens ","")

# Prep for table
postsyndenstable=postsyndensthres[,c(12,9,1,4,8)]

# Provide table with significant results highlighted
color.me <- which(postsyndenstable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
postsyndenstable=postsyndenstable %>% mutate_if(is.numeric,as.character)

postsyndenstable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")

# Ggplot effect size graph
# Subset to include standard error as well
ggpostsyndenstable=postsyndensthres[,c(12,9,1,2,4,8)]
# Turn brain region to factor to arrange it in order of dataframe
ggpostsyndenstable$brain_pathway=paste(ggpostsyndenstable$pathway, "-", ggpostsyndenstable$brain_reg)

# Rename "brain_pathway" variables - this will make the names of the cortical regions clearer in the ggplot; do this only for "ggaxontable", then "names" will be used with all other pathways
# Save column to csv file and assign non-shortened names to each variable
# names=ggaxontable$brain_pathway
# write.csv(names, "/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/subcortical/ggplot_subcortical_names.csv",quote=F,row.names=F)

# Read back in and merge with ggplot table
names=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/subcortical/ggplot_subcortical_names.csv")

# Order rows by rows of "names"
ggpostsyndenstable <- ggpostsyndenstable[match(names$brain_pathway, ggpostsyndenstable$brain_pathway),]

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order; NEED to do before cbind (below) as otherwise dataframe can't be transformed with duplicate names
ggpostsyndenstable=ggpostsyndenstable %>% mutate(row = row_number())

# Get rid of "brain pathway" - this was just used to re-order dataset
names=names[,c(2)]
ggpostsyndenstable=cbind(ggpostsyndenstable,names)

# ggplot
postsyndensplot=ggplot(ggpostsyndenstable, aes(x=reorder(names,row), y=estimate,color=pathway)) + 
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = estimate - sd_error, ymax = estimate + sd_error), width = 0.2,alpha=0.5) +
  scale_y_continuous(limits = c(-0.04, 0.04)) +
#  geom_text(aes(x = pheno, y = estimate, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  scale_x_discrete(limits=rev) +
  labs(x = "Subcortical volumes", 
       y = "Standardised effect size", 
       title = "Postsynaptic density pathway and whole-genome PRS (p < 0.1) \nin relation to subcortical volumes in ABCD") +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save plot - for manuscript
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_subcortical_postsyndens_effectsize.tiff",
#      width=2400, height=1000, res = 300)
# postsyndensplot
# dev.off()

```

### Postsynaptic membrane pathway - results

#### Clinical phenotypes

```{r postsynmemb assocs at p-threshold < 0.1, echo=FALSE}
# Read in entire results dataset
pps=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/pps/pps_scz3_final_results.csv")

ksads=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/ksads/ksads_scz3_final_results.csv")

prs_df=rbind(pps,ksads)

# Create a variable that indicates whether it is a pathway or a wg PRS
prs_df$pathway=ifelse(grepl("pathwayprs",prs_df$model),"Pathway PRS","WG PRS")

postsynmemb=subset(prs_df, grepl("postsynmemb", prs_df$model))
# Create a variable that better states the PLE and threshold (as we have now separated by pathway)
postsynmemb$ple=sub("*_snps_in_postsynmemb", "", postsynmemb$model)  
# Change name of phenotype
postsynmemb$pheno=sub(".*pps.*", "PPS total score", postsynmemb$model, ignore.case = TRUE)
postsynmemb$pheno=sub(".*distress.*", "PPS distress score", postsynmemb$pheno, ignore.case = TRUE)
postsynmemb$pheno=sub(".*psychosis.*", "KSADS current symptom score", postsynmemb$pheno, ignore.case = TRUE)

# Create a variable that selects ONLY the p-value threshold (to then subset by this) 
postsynmemb$thres=sub(".*postsynmemb_", "", postsynmemb$model)
postsynmemb$thres=sub("_pps_y_ss_number", "", postsynmemb$thres)
postsynmemb$thres=sub("_distress_score", "", postsynmemb$thres)
postsynmemb$thres=sub("_symptom_psychosis_score", "", postsynmemb$thres)
postsynmemb$thres=as.numeric(postsynmemb$thres)

# Subset for assocs at p-threshold < 0.1
postsynmembthres=subset(postsynmemb, thres ==0.1)

# Create a variable that excludes the p-value threshold from column (we already know this is just 0.1)
postsynmembthres$ple=sub("_postsynmemb_0.1*.", "", postsynmembthres$model) 

# Prep for table
postsynmembtable=postsynmembthres[,c(10,8,1,4,7)]

# Provide table with significant results highlighted
color.me <- which(postsynmembtable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
postsynmembtable=postsynmembtable %>% mutate_if(is.numeric,as.character)

postsynmembtable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")
  
# Ggplot effect size graph
# Subset to include standard error as well
ggpostsynmembtable=postsynmembthres[,c(10,8,1,2,4,7)]
# Provide rows in table that should have a star in ggplot
ggpostsynmembtable$sign[ggpostsynmembtable$pval.adj < 0.05]<-"***"
# Assign hjust and vjust
hjust = if_else(ggpostsynmembtable$pathway == "Pathway PRS", 5, -5)
vjust = if_else(ggpostsynmembtable$pathway == "Pathway PRS", 2, -1.5)

postsynmembplot=ggplot(ggpostsynmembtable, aes(x=pheno, y=Value,color=pathway)) + 
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = Value - Std.Error, ymax = Value + Std.Error), width = 0.2,alpha=0.5) +
  scale_y_continuous(limits = c(-0.25, 0.25)) +
  geom_text(aes(x = pheno, y = Value, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  labs(x = "Clinical phenotypes", 
       y = "Standardised effect size", 
       title = "Postsynaptic membrane pathway and whole-genome PRS (p < 0.1) \nin relation to clinical phenotypes in ABCD") +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_clinical_postsynmemb_effectsize.tiff",
#      width=2200, height=600, res = 300)
# postsynmembplot
# dev.off()

```

#### Imaging phenotypes

##### White matter microstructure

```{r white matter postsynmemb assocs at p-threshold < 0.1, echo=FALSE}
# Read in entire results dataset
fa_prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/dti/fdr_final_results/for_rmarkdown_file/abcd_fa_all_complete_scz3_final_results.csv")

md_prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/dti/fdr_final_results/for_rmarkdown_file/abcd_md_all_complete_scz3_final_results.csv")

prs_df=rbind(fa_prs_df,md_prs_df)

postsynmemb=subset(prs_df, grepl("postsynmemb",prs_df$name))

# Subset for assocs at p-threshold < 0.1
postsynmembthres=subset(postsynmemb, thres ==0.1)

# Prep for table
postsynmembtable=postsynmembthres[,c(12,9,1,4,8)]

# Provide table with significant results highlighted
color.me <- which(postsynmembtable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
postsynmembtable=postsynmembtable %>% mutate_if(is.numeric,as.character)

postsynmembtable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")

# Ggplot effect size graph
# Subset to include standard error as well
ggpostsynmembtable=postsynmembthres[,c(12,9,1,2,4,8)]
# Turn brain region to factor to arrange it in order of dataframe
ggpostsynmembtable$brain_pathway=paste(ggpostsynmembtable$pathway, "-", ggpostsynmembtable$brain_reg)

# Create a new column name that takes the type of imaging modality (FA or MD)
ggpostsynmembtable$mode <- ifelse(grepl("MD", ggpostsynmembtable$brain_pathway, ignore.case = T), "Mean diffusivity","Fractional anisotropy")
# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order
ggpostsynmembtable=ggpostsynmembtable %>% mutate(row = row_number())

# Rename "brain_pathway" variables - this will make the names of the cortical regions clearer in the ggplot; do this only for "ggaxontable", then "names" will be used with all other pathways
# Save column to csv file and assign non-shortened names to each variable
# names=ggaxontable$brain_pathway
# write.csv(names, "/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/ggplot_cortical_names.csv",quote=F,row.names=F)

# Read back in and merge with ggplot table
names=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/dti/ggplot_names.csv")

# Order rows by rows of "names"
ggpostsynmembtable <- ggpostsynmembtable[match(names$brain_pathway, ggpostsynmembtable$brain_pathway),]

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order; NEED to do before cbind (below) as otherwise dataframe can't be transformed with duplicate names
ggpostsynmembtable=ggpostsynmembtable %>% mutate(row = row_number())

# Get rid of "brain pathway" - this was just used to re-order dataset
names=names[,c(1)]
ggpostsynmembtable=cbind(ggpostsynmembtable,names)

### ggplot based on "mode" (different imaging modalities)
postsynmembplot <- ggplot(ggpostsynmembtable, aes(x = reorder(names,row), y = estimate, group = mode)) +
  facet_grid(. ~ mode, scales = "free", space = "free") +
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = estimate - sd_error, ymax = estimate + sd_error), width = 0.2,size=0.5,alpha=0.5) +
  scale_y_continuous(limits = c(-0.06, 0.06)) +
  scale_x_discrete(limits=rev) +
  # geom_text(aes(x = brain_region, y = Value, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  labs(x = "White matter microstructure", 
       y = "Standardised effect size", 
       title = "Postsynaptic density pathway and whole-genome PRS (p < 0.1) in relation to white matter microstructure in ABCD") +
  # scale_x_discrete(labels=function(x) highlight(x, sign, "darkgreen")) +
  theme(axis.text.y=element_markdown()) +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save plot - for manuscript
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_whitematter_postsynmemb_effectsize.tiff",
#      width=3400, height=1800, res = 300)
# postsynmembplot
# dev.off()

```

##### Cortical regions

```{r cort postsynmemb assocs at p-threshold < 0.1, echo=FALSE}
# Read in entire results dataset
prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/fdr_final_results/for_rmarkdown_file/abcd_cortical_complete_scz3_final_results.csv")

postsynmemb=subset(prs_df, grepl("postsynmemb", prs_df$name))

# Subset for assocs at p-threshold < 0.1
postsynmembthres=subset(postsynmemb, thres ==0.1)

postsynmembthres$brain_reg=str_replace_all(postsynmembthres$brain_reg, "postsynmemb ","")

# Prep for table
postsynmembtable=postsynmembthres[,c(12,9,1,4,8)]

# Provide table with significant results highlighted
color.me <- which(postsynmembtable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
postsynmembtable=postsynmembtable %>% mutate_if(is.numeric,as.character)

postsynmembtable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")

# Ggplot effect size graph
# Subset to include standard error as well
ggpostsynmembtable=postsynmembthres[,c(12,9,1,2,4,8)]
# Turn brain region to factor to arrange it in order of dataframe
ggpostsynmembtable$brain_pathway=paste(ggpostsynmembtable$pathway, "-", ggpostsynmembtable$brain_reg)

# Create a new column name that takes the type of cortical imaging modality
# Create a new variable in "bldata" that takes only the pathway name to be corrected by
ggpostsynmembtable$cortical_mod <- ifelse(grepl("thick|thickness", ggpostsynmembtable$brain_pathway, ignore.case = T), "Thickness", 
                      ifelse(grepl("area", ggpostsynmembtable$brain_pathway, ignore.case = T), "Surface area",
                             ifelse(grepl("sulc |sulcdepth", ggpostsynmembtable$brain_pathway, ignore.case = T), "Sulcal depth","Volume")))

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order
ggpostsynmembtable=ggpostsynmembtable %>% mutate(row = row_number())

# Rename "brain_pathway" variables - this will make the names of the cortical regions clearer in the ggplot; do this only for "ggaxontable", then "names" will be used with all other pathways
# Save column to csv file and assign non-shortened names to each variable
# names=ggaxontable$brain_pathway
# write.csv(names, "/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/ggplot_cortical_names.csv",quote=F,row.names=F)

# Read back in and merge with ggplot table
names=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/cortical/ggplot_cortical_names.csv")

# Order rows by rows of "names"
ggpostsynmembtable <- ggpostsynmembtable[match(names$brain_pathway, ggpostsynmembtable$brain_pathway),]

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order; NEED to do before cbind (below) as otherwise dataframe can't be transformed with duplicate names
ggpostsynmembtable=ggpostsynmembtable %>% mutate(row = row_number())

# Get rid of "brain pathway" - this was just used to re-order dataset
names=names[,c(2)]
ggpostsynmembtable=cbind(ggpostsynmembtable,names)

### ggplot based on "mode" (different imaging modalities)
postsynmembplot <- ggplot(ggpostsynmembtable, aes(x = reorder(names,row), y = estimate, group = cortical_mod)) +
  facet_grid(. ~ cortical_mod, scales = "free", space = "free") +
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = estimate - sd_error, ymax = estimate + sd_error), width = 0.2,size=0.5,alpha=0.5) +
  scale_y_continuous(limits = c(-0.06, 0.06)) +
  scale_x_discrete(limits=rev) +
  # geom_text(aes(x = brain_region, y = Value, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  labs(x = "Cortical regions", 
       y = "Standardised effect size", 
       title = "Postsynaptic membrane pathway and whole-genome PRS (p < 0.1) in relation to cortical regions in ABCD") +
  # scale_x_discrete(labels=function(x) highlight(x, sign, "darkgreen")) +
  theme(axis.text.y=element_markdown()) +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save plot - for manuscript
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_cortical_postsynmemb_effectsize.tiff",
#      width=3600, height=2600, res = 300)
# postsynmembplot
# dev.off()

```

#### Subcortical volumes

```{r subcort postsynmemb effect size, echo=FALSE}
# Read in entire results dataset
prs_df=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/subcortical/fdr_final_results/for_rmarkdown_file/abcd_subc_complete_scz3_final_results.csv")

postsynmemb=subset(prs_df, grepl("postsynmemb", prs_df$name))

# Subset for assocs at p-threshold < 0.1
postsynmembthres=subset(postsynmemb, thres ==0.1)

postsynmembthres$brain_reg=str_replace_all(postsynmembthres$brain_reg, "postsynmemb ","")

# Prep for table
postsynmembtable=postsynmembthres[,c(12,9,1,4,8)]

# Provide table with significant results highlighted
color.me <- which(postsynmembtable$pval.adj < 0.05)

# Turn all numeric columns to character JUST for display of table
postsynmembtable=postsynmembtable %>% mutate_if(is.numeric,as.character)

postsynmembtable %>% 
  kable(booktabs = T,row.names=F) %>%
  kable_styling() %>%
  row_spec(color.me, bold = T, color = "green")

# Ggplot effect size graph
# Subset to include standard error as well
ggpostsynmembtable=postsynmembthres[,c(12,9,1,2,4,8)]
# Turn brain region to factor to arrange it in order of dataframe
ggpostsynmembtable$brain_pathway=paste(ggpostsynmembtable$pathway, "-", ggpostsynmembtable$brain_reg)

# Rename "brain_pathway" variables - this will make the names of the cortical regions clearer in the ggplot; do this only for "ggaxontable", then "names" will be used with all other pathways
# Save column to csv file and assign non-shortened names to each variable
# names=ggaxontable$brain_pathway
# write.csv(names, "/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/subcortical/ggplot_subcortical_names.csv",quote=F,row.names=F)

# Read back in and merge with ggplot table
names=read.csv("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/results/abcd results/subcortical/ggplot_subcortical_names.csv")

# Order rows by rows of "names"
ggpostsynmembtable <- ggpostsynmembtable[match(names$brain_pathway, ggpostsynmembtable$brain_pathway),]

# Use dplyr to add a row number; then reorder the order of the x variable in ggplot below to have the faceted plot in a specific order; NEED to do before cbind (below) as otherwise dataframe can't be transformed with duplicate names
ggpostsynmembtable=ggpostsynmembtable %>% mutate(row = row_number())

# Get rid of "brain pathway" - this was just used to re-order dataset
names=names[,c(2)]
ggpostsynmembtable=cbind(ggpostsynmembtable,names)

# ggplot
postsynmembplot=ggplot(ggpostsynmembtable, aes(x=reorder(names,row), y=estimate,color=pathway)) + 
  theme_minimal() +
  geom_hline(yintercept=0, linetype="dashed", color = "black") +
  geom_point(aes(color = pathway),size=2.5)  +
  geom_errorbar(aes(ymin = estimate - sd_error, ymax = estimate + sd_error), width = 0.2,alpha=0.5) +
  scale_y_continuous(limits = c(-0.05, 0.05)) +
#  geom_text(aes(x = pheno, y = estimate, label = sign,vjust=vjust),hjust=-0.5) +
  coord_flip() +
  scale_x_discrete(limits=rev) +
  labs(x = "Subcortical volumes", 
       y = "Standardised effect size", 
       title = "Postsynaptic membrane pathway and whole-genome PRS (p < 0.1) \nin relation to subcortical volumes in ABCD") +
  guides(color=guide_legend(title="PRS")) +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save plot - for manuscript
# tiff("/Users/mirun/OneDrive - University of Edinburgh/Work directories/Current projects/Fellowship project/PRS manuscript/Plots/abcd_subcortical_postsynmemb_effectsize.tiff",
#      width=2400, height=1000, res = 300)
# postsynmembplot
# dev.off()

```

##### Other relevant code

- Arrange multiple plots in the same large plot

```{r ggarrange example, echo=FALSE}
# GGARRANGE FOR R2 MANUSCRIPT GRAPH 
# Arrange all bar plots into one big plot
# Run ggarrange

# models2and3_rsq=ggarrange(rsq_plot,rsq_plot_mod3,                                                 
#                         nrow = 2, ncol=1,
#                         labels = c("A","B"), font.label = list(size = 24)) 
# 
# models2and3_rsq

```